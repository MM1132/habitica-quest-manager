<? const globalData = getGlobalPageData(); ?>

<html>
  <head>
    <base target="_top">
    <?!= include('css/styles') ?>
  </head>

  <body>
    <div class="header">
      <div class="header-title">
        <h4>
          <?= globalData.scriptName ?> 
          <u>
            <?= globalData.scriptVersion ?>
          </u>
        </h4>
        <i>by <a class="link" href="https://habitica.com/profile/90c987f2-cf51-442f-b932-3c4194d56ad6">Kanguste</a></i>
      </div>
      <nav>
        <ul class="navigation-buttons">
          <li><button class="button" onclick="navigate('main')">Main</button></li>
          <li><button class="button" onclick="navigate('settings')">Settings</button></li>
          <li><button class="button" onclick="navigate('members')">Members <i>(WIP)</i></button></li>
          <li><button class="button" onclick="navigate('partyQuests')">Party Quests <i>(WIP)</i></button></li>
        </ul>
      </nav>
    </div>

    <div id="content"></div>
    
    <script>
      /* INIT */
      window.onload = () => {
        navigate('main');
      }

      /* GLOBALS */
      window.asyncInclude = async (path, props) => {
        const includePromise = new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .include(path, props);
        });

        try {
          return await includePromise;
        } catch (error) {
          console.error(`Failed to include ${path}:`, error);
        }
      }

      window.loadScriptsForElement = (element) => {
        Array.from(element.querySelectorAll('script')).forEach(oldScript => {
          const newScript = document.createElement('script');
          newScript.textContent = oldScript.innerText;
          document.head.appendChild(newScript).parentNode.removeChild(newScript);
        });
      }

      /* ####### */

      const preloadedPages = {
        main: <?= include('pages/main/index') ?>,
        settings: <?= include('pages/settings') ?>,
        members: <?= include('pages/members') ?>,
        partyQuests: <?= include('pages/partyQuests/index') ?>,
      };

      const navigate = (page) => {
        const content = document.getElementById('content');
        content.innerHTML = `<?= include('pages/components/loading') ?>`;
        
        disableNavigationButtons();

        try {
          content.innerHTML = preloadedPages[page] || 'Page not found :c';

          loadScriptsForElement(content);

          enableNavigationButtons();
        } catch (error) {
          enableNavigationButtons();
          content.innerHTML = `<h1>Failed to load page</h1><br>${error.message}`;
        }
      }

      const disableNavigationButtons = () => {
        document.querySelectorAll(".navigation-buttons .button").forEach(button => {
          button.style.pointerEvents = 'none';
        });
      }

      const enableNavigationButtons = () => {
        document.querySelectorAll(".navigation-buttons .button").forEach(button => {
          button.style.pointerEvents = 'auto';
        });
      }
    </script>
  </body>
</html>