<? let data = null; ?>

<main>
  <? if (!!data) { ?>
    <div class="section">
      <h2>Profile</h2>
      <div class="section-content">
        <ul>
          <li><strong>Profile name:</strong>
            <?= data.user.profile.name ?>
          </li>
          <li><strong>Username:</strong>
            @<?= data.user.auth.local.username ?>
          </li>
          <li><strong>Party:</strong>
            <?= data.party.name ?>
          </li>
        </ul>
      </div>
    </div>
    <!-- SETTINGS -->
    <div class="section">
      <h2>Quest Manager's User Settings</h2>
      <div class="section-content">
        <ul>
          <li><strong>Quest start threshold:</strong>
            <?= data.settings.questStartThreshold ?>%
          </li>
        </ul>
      </div>
    </div>
    <!-- CURRENT QUEST INFO -->
    <div class="section">
      <h2>Current Quest Info</h2>
      <div class="section-content">
        <? if (data.currentQuest) { ?>
          <ul>
            <li><strong>Quest name:</strong>
              <?= data.currentQuest.text ?>
            </li>
            <li>
              <strong>Drops:</strong>
              <ul>
                <li><strong>Gold:</strong>
                  <?= data.currentQuest.drop.gp ?>
                </li>
                <li><strong>Exp:</strong>
                  <?= data.currentQuest.drop.exp ?>
                </li>
                <li>
                  <strong>Items:</strong>
                  <ul>
                    <? for(let i = 0; i < data.currentQuest.drop.items.length; i++) { ?>
                    <li>
                      <?= data.currentQuest.drop.items[i].text ?>
                    </li>
                    <? } ?>
                  </ul>
                </li>
              </ul>
            </li>
            <li><strong>Quest leader:</strong>
              <?= data.currentQuest.leaderProfileName ?>
            </li>
            <li><strong>Status:</strong>
              <?= data.currentQuest.status ?>
            </li>
            <li><strong>Participating members:</strong>
              <?= data.currentQuest.memberCount ?> /
              <?= data.party.memberCount ?>
            </li>
            <li><strong>Participation percentage:</strong>
              <?= data.currentQuest.participation ?>%
            </li>
          </ul>
          <div>
            <? if ("start" in data.currentQuest.links) { ?>
              <button class="button" onclick="startQuest('<?= data.party.id ?>')">
                Start this quest
              </button>
            <? } else { ?>
              <i>no actions available</i>
            <? } ?>
          </div>
        <? } else { ?>
          <i>No active quest</i>
        <? } ?>
      </div>
    </div>
    <!-- LIST OF USER'S QUESTS -->
    <div class="section">
      <h2>Quests of <?= data.user.profile.name ?></h2>

      <div class="section-content">
        <div class="quest-list-container">
          <? for(let i = 0; i < data.quests.length; i++) { ?>
            <div class="quest-card">
              <!-- Base information -->
              <h3 class="quest-card-title">
                <?= data.quests[i].text ?> (<?= data.quests[i].count ?>)
                <!-- Quest status if it's the currently active quest -->
                <? if (data.quests[i].key === data.currentQuest?.key) { ?>
                  <i>- <?= data.currentQuest?.status ?></i>
                <? } ?>
              </h3>

              <div class="quest-card-content" id="quest-card-content-<?= i ?>">
                <ul>
                  <li>
                    <strong>Count:</strong>
                    <?= data.quests[i].count ?>
                  </li>
                  <li>
                    <strong>Drops:</strong>
                    <ul>
                      <li>
                        <strong>Gold:</strong>
                        <?= data.quests[i].drop.gp ?>
                      </li>
                      <li>
                        <strong>Exp:</strong>
                        <?= data.quests[i].drop.exp ?>
                      </li>
                      <li>
                        <strong>Items:</strong>
                        <ul>
                          <? for(let j = 0; j < data.quests[i].drop.items.length; j++) { ?>
                            <li><?= data.quests[i].drop.items[j].text ?></li>
                          <? } ?>
                        </ul>
                      </li>
                    </ul>
                  </li>
                </ul>
                
                <!-- Possible action -->
                <div>
                  <? if ("invite" in data.quests[i].links) { ?>
                    <button class="button" onclick="sendInvitations('<?= data.quests[i].key ?>')">
                      Send invitations
                    </button>
                  <? } else if ("start" in data.quests[i].links) { ?>
                    <button class="button" onclick="startQuest('<?= data.party.id ?>')">
                      Start this quest
                    </button>
                  <? } else { ?>
                    <i>no actions available</i>
                  <? } ?>
                </div>
              </div>
            </div>
          <? } ?>
        </div>
      </div>
    </div>
  <? } else { ?>
    <?!= include('pages/components/loadingIcon') ?>
  <? } ?>
</main>

<script type="module">
  (() => {
    window.startQuest = (partyId) => {
      google.script.run.withSuccessHandler(() => {
        reloadTheData();
      }).forceStartQuest(partyId);
    }

    window.sendInvitations = (questKey) => {
      google.script.run.withSuccessHandler(() => {
        reloadTheData();
      }).inviteMembersToQuest(questKey);
    }

    window.fetchData = async () => {
      const dataPromise = new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getMainPageData();
      });
    }

    reloadTheData();

    const questCards = document.getElementsByClassName('quest-card');

    for (let i = 0; i < questCards.length; i++) {
      questCards[i].addEventListener('click', () => {
        const questCardContent = document.getElementById(`quest-card-content-${i}`);

        if (questCardContent.style.maxHeight) {
          questCardContent.style.maxHeight = null;
        } else {
          questCardContent.style.maxHeight = questCardContent.scrollHeight + "px";
        }
      });
    }
  })()
</script>
